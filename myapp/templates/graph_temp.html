{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique Température</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 30px 0;
        }
        .card-graph {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .filter-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 25px;
            margin-bottom: 30px;
        }
        canvas {
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">Historique Température (DHT11)</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg">
                ← Retour au dashboard
            </a>
        </div>

        <!-- FILTRE PROFESSIONNEL -->
        <div class="filter-card">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">Date de début</label>
                    <input type="datetime-local" name="debut" value="{{ debut }}" class="form-control form-control-lg">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">Date de fin</label>
                    <input type="datetime-local" name="fin" value="{{ fin }}" class="form-control form-control-lg">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-lg w-100">Charger</button>
                </div>
                <div class="col-md-2">
                    <a href="?export=csv{% if debut %}&debut={{ debut }}{% endif %}{% if fin %}&fin={{ fin }}{% endif %}"
                       class="btn btn-success btn-lg w-100">
                       Télécharger CSV
                    </a>
                </div>
            </form>
        </div>

        <!-- GRAPHIQUE -->
        <div class="card-graph">
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <script>
        fetch('/api/dlist/')
            .then(r => r.json())
            .then(res => {
                let data = res.data;

                // Filtre côté JS pour cohérence avec le serveur
                {% if debut %}
                    const debutDate = new Date("{{ debut }}");
                    data = data.filter(d => new Date(d.dt) >= debutDate);
                {% endif %}
                {% if fin %}
                    const finDate = new Date("{{ fin }}:59");
                    data = data.filter(d => new Date(d.dt) <= finDate);
                {% endif %}

                // Ordre chronologique
                data = data.sort((a, b) => new Date(a.dt) - new Date(b.dt));

                const labels = data.map(d => new Date(d.dt).toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }));

                const temps = data.map(d => d.temp);

                new Chart(document.getElementById('tempChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Température (°C)',
                            data: temps,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { font: { size: 16 } } },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { font: { size: 14 } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 13 },
                                    color: '#555'
                                }
                            }
                        }
                    }
                });
            });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>