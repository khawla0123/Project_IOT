{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard DHT11</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- BARRE HAUT -->
<nav class="navbar navbar-light bg-white shadow-sm px-4">
    <span class="navbar-brand fw-bold text-primary">
        ğŸŒ¡ï¸ Dashboard DHT11
    </span>

    {% if user.is_authenticated %}
        <span class="d-flex align-items-center">
            ğŸ‘· {{ user.username }}
     <!-- admin -->
             {% if user.is_staff %}
            <a href="/admin/" class="btn btn-outline-dark btn-sm">
                ğŸ› ï¸ Admin
            </a>
        {% endif %}
            <!-- admin-->
            <form method="post" action="{% url 'logout' %}" class="ms-2">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    DÃ©connexion
                </button>
            </form>
        </span>
    {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-primary btn-sm">
            ğŸ” Login
        </a>
    {% endif %}
</nav>


<div class="container py-5">

    <h2 class="text-center mb-5 text-primary fw-bold">
        TempÃ©rature & HumiditÃ©
    </h2>

    <!-- TEMP + HUM -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow text-center">
                <div class="card-header bg-primary text-white">TempÃ©rature</div>
                <div class="card-body">
                    <h1>{{ dernier.temp|default:"--" }} Â°C</h1>
                    <p class="text-muted">Il y a {{ dernier.dt|timesince }}</p>

                <a href="{% url 'graph_temp' %}" class="btn btn-outline-primary btn-sm">
                  ğŸ“ˆ Voir graphe tempÃ©rature
</a>
                    </div>

            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow text-center">
                <div class="card-header bg-primary text-white">HumiditÃ©</div>
                <div class="card-body">
                    <h1>{{ dernier.hum|default:"--" }} %</h1>
                    <p class="text-muted">Il y a {{ dernier.dt|timesince }}</p>
                    <a href="{% url 'graph_hum' %}" class="btn btn-outline-primary btn-sm">
    ğŸ“Š Voir graphe humiditÃ©
</a>

                </div>
            </div>
        </div>
    </div>

    <!-- INCIDENT -->
<div class="row mt-5">
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning">
                ğŸš¨ Ã‰tat du systÃ¨me
            </div>
            <div class="card-body">

                {% if incident_actif %}
                    <h5 class="text-danger">Incident en cours</h5>
                    <p>Compteur alertes : {{ incident_actif.compteur_alerte }}</p>

                    <!-- QUI EST NOTIFIÃ‰ -->
                    <ul class="mb-3">
                        {% if incident_actif.compteur_alerte >= 1 %}
                            <li>ğŸ“¢ OpÃ©rateur niveau 1 notifiÃ©</li>
                        {% endif %}
                        {% if incident_actif.compteur_alerte >= 4 %}
                            <li>ğŸ“¢ OpÃ©rateur niveau 2 notifiÃ©</li>
                        {% endif %}
                        {% if incident_actif.compteur_alerte >= 7 %}
                            <li>ğŸ“¢ OpÃ©rateur niveau 3 notifiÃ©</li>
                        {% endif %}
                    </ul>

                    <!-- CAS UTILISATEUR CONNECTÃ‰ -->
                    {% if user.is_authenticated and accuse %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="accuse_id" value="{{ accuse.id }}">

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" checked disabled>
                                <label class="form-check-label">
                                    AccusÃ© de rÃ©ception
                                </label>
                            </div>

                            <textarea name="commentaire"
                                      class="form-control mb-3"
                                      placeholder="Votre commentaire...">{{ accuse.commentaire }}</textarea>

                            <button class="btn btn-success btn-sm">
                                ğŸ’¾ Enregistrer
                            </button>
                        </form>

                    <!-- CAS NON CONNECTÃ‰ -->
                    {% elif not user.is_authenticated %}
                        <p class="text-muted">
                            ğŸ” Connectez-vous pour accuser rÃ©ception
                        </p>
                    {% endif %}

                {% else %}
                    <h5 class="text-success">ğŸŸ¢ Aucun incident</h5>
                {% endif %}

            </div>
        </div>
    </div>
</div>


    <!-- ARCHIVE -->
    <div class="row mt-4">
        <div class="col-md-6">
            <a href="{% url 'archive_incidents' %}" class="btn btn-outline-secondary">
                ğŸ“‚ Voir archive des incidents
            </a>
        </div>
    </div>

</div>

<!-- TEST API -->
<div class="row mt-5"> <div class="col-md-6 mx-auto"> <div class="card shadow-lg">
    <div class="card-header bg-secondary text-white text-center"> <h4>Test API (Envoi manuel)</h4> </div>
    <div class="card-body"> <form id="testForm"> {% csrf_token %} <label>TempÃ©rature (Â°C)</label>
        <input type="number" step="0.1" id="tempInput" class="form-control mb-3" required>
        <label>HumiditÃ© (%)</label>
        <input type="number" step="0.1" id="humInput" class="form-control mb-3" required>
        <button class="btn btn-primary w-100">Envoyer</button>
    </form> <div id="result" class="mt-3"></div> </div>
</div> </div> </div> </div>
<script>
    document.getElementById("testForm").onsubmit = async (e) => { e.preventDefault();
 const temp = parseFloat(document.getElementById("tempInput").value);
  const hum = parseFloat(document.getElementById("humInput").value);
 const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value; const res = document.getElementById("result");
  res.innerHTML = "Envoi en cours...";
   const response = await fetch("/api/dht11/", { method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": csrf }, body: JSON.stringify({ temp, hum }) });
   const data = await response.json();
    if (response.ok) { res.innerHTML = "âœ… Mesure enregistrÃ©e"; setTimeout(() => location.reload(), 1500);
     } else { res.innerHTML = "âŒ Erreur : " + JSON.stringify(data); } };
</script>

</body>
</html>
